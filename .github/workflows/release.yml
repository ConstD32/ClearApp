name: Release Build

on:
  push:
    tags:
      - 'v*'  # Триггеримся на теги вида v1.0.0, v1.2.3
      - 'v*-beta*'  # Для бета-релизов

# Разрешаем запуск из других workflow (для CI/CD цепочки)
permissions:
  contents: write  # Для создания релизов
  discussions: write  # Для создания обсуждений релиза (опционально)

jobs:
  create-release:
    runs-on: windows-latest  # Сборка под Windows
    strategy:
      matrix:
        target: [x86_64-pc-windows-msvc]
        # Для кроссплатформенности можно добавить:
        # target: [x86_64-pc-windows-msvc, x86_64-unknown-linux-gnu, x86_64-apple-darwin]

    steps:
      # Шаг 1: Получение кода
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Полная история для автоинкремента версий

      # Шаг 2: Настройка Rust
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}
          components: rust-std

      # Шаг 3: Кэширование зависимостей (ускоряет сборку)
      - name: Cache Cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # Шаг 4: Сборка релизной версии
      - name: Build release binary
        run: |
          cargo build --release --target ${{ matrix.target }}
          # Проверяем, что бинарник создан
          dir "target/${{ matrix.target }}/release/" || echo "Directory not found"

      # Шаг 5: Подготовка имени файла с версией
      - name: Extract version from tag
        id: get_version
        run: |
          # Извлекаем версию из тега (v1.2.3 -> 1.2.3)
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT
          # Также получаем предыдущий тег для changelog
          $prev_tag = git describe --tags --abbrev=0 HEAD^ 2>$null || echo "v0.0.0"
          echo "PREV_TAG=$prev_tag" >> $env:GITHUB_OUTPUT

      # Шаг 6: Создание changelog (опционально, но рекомендуется)
      - name: Generate changelog
        id: changelog
        run: |
          $prev_tag = "${{ steps.get_version.outputs.PREV_TAG }}"
          $current_tag = "${{ steps.get_version.outputs.TAG }}"
          
          # Генерируем changelog из коммитов
          if ($prev_tag -eq "v0.0.0") {
            $changelog = git log --oneline --pretty=format:"- %s" HEAD
          } else {
            $changelog = git log --oneline --pretty=format:"- %s" ${prev_tag}..${current_tag}
          }
          
          # Форматируем вывод
          $changelog = "## Changes in $current_tag`n`n" + $changelog
          $changelog = $changelog -replace "`"", "'"  # Заменяем двойные кавычки
          
          # Сохраняем в файл
          $changelog | Out-File -FilePath "CHANGELOG_${current_tag}.md" -Encoding UTF8
          
          echo "CHANGELOG<<EOF" >> $env:GITHUB_OUTPUT
          echo "$changelog" >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT

      # Шаг 7: Создание релиза на GitHub
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.TAG }}
          tag_name: ${{ steps.get_version.outputs.TAG }}
          body: |
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ### Assets
            • `ClearApp.exe` - Основной исполняемый файл
            • `ClearApp.sha256` - Контрольная сумма
            
            ### Как установить
            1. Скачайте `ClearApp.exe`
            2. Запустите программу
          draft: false  # Сразу публикуем
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          files: |
            target/${{ matrix.target }}/release/ClearApp.exe
            target/${{ matrix.target }}/release/ClearApp.pdb  # Если нужны отладочные символы
            CHANGELOG_${{ steps.get_version.outputs.TAG }}.md
          generate_release_notes: true  # Автогенерация notes от GitHub

      # Шаг 8: Создание контрольных сумм (опционально, но полезно)
      - name: Create checksums
        run: |
          cd "target/${{ matrix.target }}/release/"
          Get-FileHash -Algorithm SHA256 ClearApp.exe | Out-File -FilePath ClearApp.sha256
          Get-Content ClearApp.sha256

      # Шаг 9: Обновление релиза с добавлением контрольных сумм
      - name: Upload checksums to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.TAG }}
          files: target/${{ matrix.target }}/release/ClearApp.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}