name: Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:

      # ---------------- CHECKOUT ----------------

      - name: Checkout
        uses: actions/checkout@v4

      # ---------------- RUST ----------------

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # ---------------- BUILD ----------------

      - name: Build release
        run: cargo build --release

      # ---------------- PACKAGE NAME ----------------

      - name: Detect package name
        id: pkg
        shell: powershell
        run: |
          $name = (Select-String -Path Cargo.toml -Pattern '^name\s*=\s*"(.*)"').Matches[0].Groups[1].Value
          echo "name=$name" >> $env:GITHUB_OUTPUT

      # ---------------- TARGET TRIPLE ----------------

      - name: Detect target triple
        id: target
        shell: powershell
        run: |
          $t = rustc -vV | Select-String host | % { $_.ToString().Split()[1] }
          echo "triple=$t" >> $env:GITHUB_OUTPUT

      # ---------------- ZIP ----------------

      - name: Create update zip
        shell: powershell
        run: |
          mkdir dist
          copy target\release\${{ steps.pkg.outputs.name }}.exe dist\
          Compress-Archive `
            -Path dist\${{ steps.pkg.outputs.name }}.exe `
            -DestinationPath `
            ${{ steps.pkg.outputs.name }}-${{ steps.target.outputs.triple }}.zip

      # ---------------- HASH ----------------

      - name: Compute SHA256
        id: hash
        shell: powershell
        run: |
          $f="${{ steps.pkg.outputs.name }}-${{ steps.target.outputs.triple }}.zip"
          $h=(Get-FileHash $f -Algorithm SHA256).Hash.ToLower()
          $s=(Get-Item $f).Length
          echo "sha=$h" >> $env:GITHUB_OUTPUT
          echo "size=$s" >> $env:GITHUB_OUTPUT

      # ---------------- VERSION ----------------

      - name: Detect version
        id: ver
        shell: powershell
        run: |
          if ("${{ github.ref_type }}" -eq "tag") {
            $v = "${{ github.ref_name }}".TrimStart("v")
          } else {
            $v = (Select-String -Path Cargo.toml -Pattern '^version\s*=\s*"(.*)"').Matches[0].Groups[1].Value
          }
          echo "version=$v" >> $env:GITHUB_OUTPUT

      # ---------------- latest.yml ----------------

      - name: Generate latest.yml
        shell: powershell
        run: |
          $zip="${{ steps.pkg.outputs.name }}-${{ steps.target.outputs.triple }}.zip"

          @"
          version: ${{ steps.ver.outputs.version }}
          path: $zip
          sha256: ${{ steps.hash.outputs.sha }}
          size: ${{ steps.hash.outputs.size }}
          "@ | Out-File latest.yml -Encoding utf8

      # ---------------- RELEASE ----------------

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.zip
            latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
